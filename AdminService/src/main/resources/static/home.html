<!DOCTYPE html>
<html>

<head>
  <title>Home</title>
  <script>
    async function loadAuthorization() {
      const token = localStorage.getItem("Authorization");

      if (!token) {
        window.location.href = "/index.html";
      }
    }
  </script>
</head>

<body>
  <h1>Home Page</h1>

  <h2>Your uploaded documentation</h2>
  <div class="docs-container">
    <button id="load-docs" onclick="appendDocumentRow()">Load Documents</button>
    <table id="docs-table">
      <thead>
        <tr>
          <th>Document Type</th>
          <th>Size (bytes)</th>
          <th>Creation Date</th>
          <th>Expiration Date</th>
        </tr>
      </thead>
      <tbody id="docs-body"></tbody>

  </div>

  <h3>upload documentation</h3>
  <form>
    <label for="file">Select file:</label>
    <input type="file" placeholder="Upload" id="file" oninput="storeFile()"><br>
    <label for="document-type">Document Type:</label>
    <input type="text" placeholder="document type" id="document-type"><br>
    <label for="creation-date">Creation Date:</label>
    <input type="datetime" placeholder="creation-date" id="creation-date"><br>
    <label for="expiration-date">Expiration Date:</label>
    <input type="datetime" placeholder="expiration-date" id="expiration-date"><br>
    <input type="button" value="upload" onclick="upload()">
  </form>

  <button onclick="test()">Test</button>
  <p id="test"></p>
</body>

<script>
  const documents = [];
  async function test() {
    const response = fetch("/auth/from-token", {
      headers: {
        "token": localStorage.getItem("Authorization"),
        "Authorization": localStorage.getItem("Authorization")
      }
    });
    document.getElementById("test").innerText = await response.toString();
  }

  function storeFile() {
    const fileInput = document.getElementById("file");
    const fileTypeInput = document.getElementById("document-type");
    fileInput.documentType = fileTypeInput.value;
    documents.push(fileInput.files[0]);

    console.log(documents);
  }
  async function upload() {

    let totalSize = 0;
    for (const doc of documents) {
      totalSize += doc.size;
    }

    if (documents.length === 0) {
      alert("Please select a file to upload.");
      return;
    }
    const data = JSON.stringify({
      "documents": documents,
      "operation": "DOCUMENT_CREATION",
      "userId": null,
      "size": totalSize,
      "creationDate": document.getElementById("creation-date").value,
      "expirationDate": document.getElementById("expiration-date").value
    });

    const uploadReponse = fetch("/documentation/upload", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "token": localStorage.getItem("Authorization"),
      },
      body: data
    });
    console.log(await uploadReponse);

  }

  async function appendDocumentRow() {

    const table = document.getElementById("docs-table");

    const response = fetch("http://localhost:8080/documentation/get-docs", {
      headers: {
        "token": localStorage.getItem("Authorization")
      }
    })
      .then(response => response.json())
      .then(documents => {
        if (documents.length === 0) {
          alert("No documents found");
          return;
        }
        for (const document of documents) {
          const row = document.createElement("tr");
          row.innerHTML = `
    <tr>
      <td>${document.documentType}</td>
      <td>${document.size}</td>
      <td>${document.creationDate}</td>
      <td>${document.expirationDate}</td>
    </tr>
    `;
          table.appendChild(row);
        }
      })
      .catch(error => {
        alert("Failed to load documents: " + (error && error.message ? error.message : 'Network error'));
      });
  }
</script>

</html>
