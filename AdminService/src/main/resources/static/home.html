<!DOCTYPE html>
<html>

<head>
  <title>Home</title>
  <script>
    async function loadAuthorization() {
      const token = localStorage.getItem("Authorization");

      if (!token) {
        window.location.href = "/index.html";
      }
    }
  </script>
</head>

<body>
  <h1>Home Page</h1>

  <h2>Your uploaded documentation</h2>
  <div class="docs-container">
    <button id="load-docs" onclick="appendDocumentRow()">Load Documents</button>
    <table id="docs-table" style="display: block;">
      <thead>
        <tr>
          <th>Document Type</th>
          <th>Size (bytes)</th>
          <th>Creation Date</th>
          <th>Expiration Date</th>
        </tr>
      </thead>
      <tbody id="docs-body"></tbody>

  </div>

  <h3>upload documentation</h3>
  <form>
    <label for="file">Select file:</label>
    <input type="file" placeholder="Upload" id="file"><br>
    <label for="document-type">Document Type:</label>
    <input type="text" placeholder="document type" id="document-type"><br>
    <label for="creation-date">Creation Date:</label>
    <input type="date" placeholder="creation-date" id="creation-date"><br>
    <label for="expiration-date">Expiration Date:</label>
    <input type="date" placeholder="expiration-date" id="expiration-date"><br>
    <input type="button" value="upload" onclick="upload()">
  </form>

  <button onclick="test()">Test</button>
  <p id="test"></p>
</body>

<script>
  async function upload() {

    const documents = [];
    let totalSize = 0;

    const fileInput = document.getElementById("file");
    const fileTypeInput = document.getElementById("document-type");

    let creationDate = document.getElementById("creation-date").value;
    let expirationDate = document.getElementById("expiration-date").value;
    creationDate = creationDate + "T00:00:00";
    expirationDate = expirationDate + "T00:00:00";

    const b64Data = await fileToBase64(fileInput.files[0]);

    documents.push({
      "id": null,
      "userId": null,
      "documentType": fileTypeInput.value,
      "creationDate": creationDate,
      "expirationDate": expirationDate,
      "data": b64Data,
    });

    console.log(documents);
    for (const doc of documents) {
      totalSize += doc.data.length;
    }

    if (documents.length === 0) {
      alert("Please select a file to upload.");
      return;
    }
    const data = JSON.stringify({
      "documents": documents,
      "operation": "DOCUMENT_CREATION",
      "userId": null,
      "size": totalSize,
    });

    const uploadReponse = fetch("/documentation/upload", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": localStorage.getItem("Authorization")
      },
      body: data
    });
    console.log(await uploadReponse);

  }

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function appendDocumentRow() {

    const table = document.getElementById("docs-body");

    const response = await fetch("http://localhost:8080/documentation/get-docs", {
      headers: {
        "Authorization": localStorage.getItem("Authorization")
      }
    })
      .then(response => response.json())
      .then(documents => {
        if (documents.length === 0) {
          alert("No documents found");
          table.innerHTML = "";
          table.style.display = "none";
          return;
        } else {
          table.style.display = "block";
        }
        for (const file of documents) {
          const row = document.createElement("tr");
          if (file.data == null) {
            file.data = "";
          }
          row.innerHTML = `
            <td>${file.documentType}</td>
            <td>${file.data.length}</td>
            <td>${file.creationDate}</td>
            <td>${file.expirationDate}</td>
            `;
          table.appendChild(row);
        }
      })
      .catch(error => {
        alert("Failed to load documents: " + (error && error.message ? error.message : 'Network error'));
      });
  }
</script>

</html>
